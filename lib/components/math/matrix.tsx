import { cx, Html, styled } from "@/helpers/client";
import { Model } from "@/reactivity";
import { Field, TupleField } from "@/schema/fields";
import { M } from "./m";
import styles from "./matrix.module.scss";

type MatrixContentProps =
  | { matrix: readonly (readonly Html[])[]; column?: never; row?: never }
  | { matrix?: never; column: readonly Html[]; row?: never }
  | { matrix?: never; column?: never; row: readonly Html[] };

export interface MatrixDisplayProps {
  labelTex?: string;
  subscriptTex?: string;
  label?: Html;
  commas?: boolean;
  className?: string;
}

const Matrix = ({
  matrix,
  column,
  row,
  labelTex,
  subscriptTex,
  label,
  commas,
  className,
}: MatrixDisplayProps & MatrixContentProps) => {
  const cols = column ? 1 : row ? row.length : matrix ? matrix[0].length : 1;

  return (
    <div className={cx(styles.root, className)}>
      {label}

      {labelTex && (
        <M
          t={`${labelTex} ${
            labelTex.charAt(labelTex.length - 1) !== "=" ? "\\doteq" : ""
          }`}
        />
      )}

      <div
        className={cx(styles.matrix, commas && styles.withCommas)}
        style={{
          gridTemplateColumns: `repeat(${cols}, 1fr)`,
        }}
      >
        <div className={styles.leftParen}>
          <svg width="552" height="1810" viewBox="0 0 552 1810">
            <path
              fill="currentColor"
              d="M546,0.50013816 C550,4.50124344 552,7.5020724 552,9.50262503 C552,12.1700286 543.666667,25.1736207 527,48.5134015 C510.333333,71.8531823 488.666667,106.529428 462,152.542139 C435.333333,198.554849 406.666667,252.236345 376,313.586626 C345.333333,374.936907 314.333333,453.958736 283,550.652114 C251.666667,647.345491 225,749.040251 203,855.736391 C151.666667,1111.14028 126,1413.89058 126,1763.98729 C126,1785.32652 125.666667,1797.99668 125,1801.99779 C124.333333,1805.99889 122.666667,1808.33287 120,1808.99972 C118.666667,1809.66657 103.666667,1810 75,1810 C30.3333333,1810 7.33333333,1809.66657 6,1808.99972 C2.66666667,1807.66602 1,1803.99834 1,1797.99668 C1,1791.99503 0.666666667,1771.9895 0,1737.98011 C1.33333333,1615.94639 5.66666667,1502.24832 13,1396.88588 C20.3333333,1291.52344 34.6666667,1174.15769 56,1044.78862 C77.3333333,915.419545 105.666667,795.386387 141,684.689141 C176.333333,573.991895 223.666667,459.626969 283,341.594363 C342.333333,223.561757 412.666667,115.86534 494,18.5051119 C495.333333,16.5045593 497,14.5040066 499,12.503454 C501,10.5029014 502.333333,8.83577415 503,7.5020724 C503.666667,6.16837064 504.333333,5.16809432 505,4.50124344 C505.666667,3.83439256 506.666667,3.16754168 508,2.5006908 C509.333333,1.83383992 510.333333,1.50041448 511,1.50041448 C511.666667,1.50041448 513.333333,1.16698904 516,0.50013816 C518.666667,-0.16671272 520.666667,-0.16671272 522,0.50013816 L546,0.50013816 Z"
            />
          </svg>

          <svg
            width="552"
            height="621"
            viewBox="0 0 552 621"
            preserveAspectRatio="none"
          >
            <path
              fill="currentColor"
              d="M122,1.5012087 L116,1.5012087 C112.666667,1.5012087 106.333333,1.16760677 97,0.500402901 C87.6666667,-0.166800967 76.3333333,-0.166800967 63,0.500402901 C27,0.500402901 8,0.834004835 6,1.5012087 C4,2.16841257 2.66666667,3.50282031 2,5.50443191 C0.666666667,12.1764706 0,56.2119259 0,137.610798 L0,310.750201 C0,512.24577 0.333333333,613.994359 1,615.995971 L5,619.999194 C6.33333333,620.666398 29.6666667,621 75,621 L116,621 C119.333333,621 121,620.666398 121,619.999194 C123.666667,619.999194 125,614.327961 125,602.985496 C125,591.64303 125.333333,551.9444 126,483.889605 L126,137.610798 C126,46.8710717 124.666667,1.5012087 122,1.5012087 Z"
            />
          </svg>

          <svg width="552" height="1810" viewBox="0 0 552 1810">
            <path
              fill="currentColor"
              d="M 546 1809 C 550 1805 552 1802 552 1800 C 552 1797.3 543.7 1784.3 527 1761 C 510.3 1737.7 488.7 1703 462 1657 C 435.3 1611 406.7 1557.3 376 1496 C 345.3 1434.7 314.3 1355.7 283 1259 C 251.7 1162.3 225 1060.7 203 954 C 151.7 698.7 126 396 126 46 C 126 24.7 125.7 12 125 8 C 124.3 4 122.7 1.7 120 1 C 118.7 0.3 103.7 0 75 0 C 30.3 0 7.3 0.3 6 1 C 2.7 2.3 1 6 1 12 C 1 18 0.7 38 0 72 C 1.3 194 5.7 307.7 13 413 C 20.3 518.3 34.7 635.7 56 765 C 77.3 894.3 105.7 1014.3 141 1125 C 176.3 1235.7 223.7 1350 283 1468 C 342.3 1586 412.7 1693.7 494 1791 C 495.3 1793 497 1795 499 1797 C 501 1799 502.3 1800.7 503 1802 C 503.7 1803.3 504.3 1804.3 505 1805 C 505.7 1805.7 506.7 1806.3 508 1807 C 509.3 1807.7 510.3 1808 511 1808 C 511.7 1808 513.3 1808.3 516 1809 C 518.7 1809.7 520.7 1809.7 522 1809 L 546 1809 Z"
            />
          </svg>
        </div>

        {matrix &&
          matrix.map((row, i) =>
            row.map((el, j) => (
              <MatrixComponent key={`${i},${j}`}>
                {el}
                {commas && j < row.length - 1 && <Comma />}
              </MatrixComponent>
            )),
          )}

        {row &&
          row.map((el, i) => (
            <MatrixComponent key={i}>
              {el}
              {commas && i < row.length - 1 && <Comma />}
            </MatrixComponent>
          ))}

        {column &&
          column.map((el, i) => (
            <MatrixComponent key={i}>{el}</MatrixComponent>
          ))}

        <div className={styles.rightParen}>
          <svg width="552" height="1810" viewBox="0 0 552 1810">
            <path
              fill="currentColor"
              d="M6,0.50013816 L30,0.50013816 C31.3333333,-0.16671272 33.3333333,-0.16671272 36,0.50013816 C38.6666667,1.16698904 40.3333333,1.50041448 41,1.50041448 C41.6666667,1.50041448 42.6666667,1.83383992 44,2.5006908 C45.3333333,3.16754168 46.3333333,3.83439256 47,4.50124344 C47.6666667,5.16809432 48.3333333,6.16837064 49,7.5020724 C49.6666667,8.83577415 51,10.5029014 53,12.503454 C55,14.5040066 56.6666667,16.5045593 58,18.5051119 C139.333333,115.86534 209.666667,223.561757 269,341.594363 C328.333333,459.626969 375.666667,573.991895 411,684.689141 C446.333333,795.386387 474.666667,915.419545 496,1044.78862 C517.333333,1174.15769 531.666667,1291.52344 539,1396.88588 C546.333333,1502.24832 550.666667,1615.94639 552,1737.98011 C551.333333,1771.9895 551,1791.99503 551,1797.99668 C551,1803.99834 549.333333,1807.66602 546,1808.99972 C544.666667,1809.66657 521.666667,1810 477,1810 C448.333333,1810 433.333333,1809.66657 432,1808.99972 C429.333333,1808.33287 427.666667,1805.99889 427,1801.99779 C426.333333,1797.99668 426,1785.32652 426,1763.98729 C426,1413.89058 400.333333,1111.14028 349,855.736391 C327,749.040251 300.333333,647.345491 269,550.652114 C237.666667,453.958736 206.666667,374.936907 176,313.586626 C145.333333,252.236345 116.666667,198.554849 90,152.542139 C63.3333333,106.529428 41.6666667,71.8531823 25,48.5134015 C8.33333333,25.1736207 0,12.1700286 0,9.50262503 C0,7.5020724 2,4.50124344 6,0.50013816 Z"
            />
          </svg>

          <svg
            width="552"
            height="621"
            viewBox="0 0 552 621"
            preserveAspectRatio="none"
          >
            <path
              fill="currentColor"
              d="M430,1.5012087 L436,1.5012087 C439.333333,1.5012087 445.666667,1.16760677 455,0.500402901 C464.333333,-0.166800967 475.666667,-0.166800967 489,0.500402901 C525,0.500402901 544,0.834004835 546,1.5012087 C548,2.16841257 549.333333,3.50282031 550,5.50443191 C551.333333,12.1764706 552,56.2119259 552,137.610798 L552,310.750201 C552,512.24577 551.666667,613.994359 551,615.995971 L547,619.999194 C545.666667,620.666398 522.333333,621 477,621 L436,621 C432.666667,621 431,620.666398 431,619.999194 C428.333333,619.999194 427,614.327961 427,602.985496 C427,591.64303 426.666667,551.9444 426,483.889605 L426,137.610798 C426,46.8710717 427.333333,1.5012087 430,1.5012087 Z"
            />
          </svg>

          <svg width="552" height="1810" viewBox="0 0 552 1810">
            <path
              fill="currentColor"
              d="M6,1809 C2,1805 0,1802 0,1800 C0,1797.33333 8.33333333,1784.33333 25,1761 C41.6666667,1737.66667 63.3333333,1703 90,1657 C116.666667,1611 145.333333,1557.33333 176,1496 C206.666667,1434.66667 237.666667,1355.66667 269,1259 C300.333333,1162.33333 327,1060.66667 349,954 C400.333333,698.666667 426,396 426,46 C426,24.6666667 426.333333,12 427,8 C427.666667,4 429.333333,1.66666667 432,1 C433.333333,0.333333333 448.333333,0 477,0 C521.666667,0 544.666667,0.333333333 546,1 C549.333333,2.33333333 551,6 551,12 C551,18 551.333333,38 552,72 C550.666667,194 546.333333,307.666667 539,413 C531.666667,518.333333 517.333333,635.666667 496,765 C474.666667,894.333333 446.333333,1014.33333 411,1125 C375.666667,1235.66667 328.333333,1350 269,1468 C209.666667,1586 139.333333,1693.66667 58,1791 C56.6666667,1793 55,1795 53,1797 C51,1799 49.6666667,1800.66667 49,1802 C48.3333333,1803.33333 47.6666667,1804.33333 47,1805 C46.3333333,1805.66667 45.3333333,1806.33333 44,1807 C42.6666667,1807.66667 41.6666667,1808 41,1808 C40.3333333,1808 38.6666667,1808.33333 36,1809 C33.3333333,1809.66667 31.3333333,1809.66667 30,1809 L6,1809 Z"
            />
          </svg>
        </div>

        {subscriptTex && (
          <span className={styles.subscript}>
            <M t={subscriptTex} />
          </span>
        )}
      </div>
    </div>
  );
};

const modelToRow = <Es extends readonly Field[]>(
  model: Model<TupleField<Es>>,
  component: (componentModel: Model<Es[number]>, i: number) => Html,
): readonly Html[] => model.elements.map(component);

const modelToColumn = modelToRow;

const modelToMatrix = <Es extends readonly Field[]>(
  model: Model<TupleField<readonly TupleField<Es>[]>>,
  component: (
    componentModel: Model<Es[number]>,
    row: number,
    column: number,
  ) => Html,
): readonly (readonly Html[])[] =>
  model.elements.map((rowModel, row) =>
    (rowModel.elements as any[]).map((componentModel, column) =>
      component(componentModel, row, column),
    ),
  );

const exported = Object.assign(Matrix, {
  modelToRow,
  modelToColumn,
  modelToMatrix,
});
export { exported as Matrix };

const MatrixComponent = styled.div(styles.matrixComponent);

const Comma = () => {
  return (
    <svg
      className={styles.comma}
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 -121 278 315"
    >
      <title>,</title>
      <path
        fill="currentColor"
        transform="matrix(1 0 0 -1 0 0)"
        d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"
      ></path>
    </svg>
  );
};
